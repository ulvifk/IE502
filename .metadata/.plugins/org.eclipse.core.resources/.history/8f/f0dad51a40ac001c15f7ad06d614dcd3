import java.util.ArrayList;

import gurobi.GRB;
import gurobi.GRBConstr;
import gurobi.GRBEnv;
import gurobi.GRBException;
import gurobi.GRBModel;
import gurobi.GRBVar;

public class Model {
	GRBModel model;
	Variables variables;
	
	public Model(Network network) throws GRBException {
		GRBEnv env = new GRBEnv();
		this.model = new GRBModel(env);
		
		this.variables = new Variables(network, model);
		Objective obj = new Objective(model, variables, network);
		Constraints constraints = new Constraints(model, network, variables);
		this.model.optimize();
		
		this.model.write("Model.lp");
		if(this.model.get(GRB.IntAttr.Status) == GRB.INFEASIBLE) {
			this.model.computeIIS();
			
			for(GRBConstr c : this.model.getConstrs()) {
				if(c.get(GRB.IntAttr.IISConstr) == 1) {
					System.out.println(c.get(GRB.StringAttr.ConstrName));
				}
			}
		}
		ArrayList<Node> order = new ArrayList<>();
		order.add(network.getStartingDepot());
		orderTruckRoute(order, network.getStartingDepot(), network.getEndingDepot());
		
		for(Node node : order) {
			System.out.println(node.getIndex());
		}
		
		this.model.dispose();
		env.dispose();
	}
	
	private void orderTruckRoute(ArrayList<Node> order, Node i, Node stop) throws GRBException {
		if(i == stop) return;
		
		Node nextNode = null;
		for(Node j : this.variables.getX().get(i).keySet()) {
			GRBVar x = this.variables.getX().get(i).get(j);
			double xValue = x.get(GRB.DoubleAttr.X);
			if(xValue > 0.8) {
				nextNode = j;
				break;
			}
		}
		order.add(nextNode);
		
		orderTruckRoute(order, nextNode, stop);
	}
	
	private void writeSolution() {
		
	}
}
